<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game_hall</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/game_hall.css">
</head>
<body>
    <div class="nav">Gobang</div>
    <!-- 整个页面的容器元素 -->
    <div class="container">
        <!-- 这个div 在container 中是处于垂直水平居中这样的位置 -->
        <div>
            <!-- 展示用户信息 -->
            <div id="screen"></div>
            <!-- 按钮匹配，第一次点击，开始匹配，再点一下，文本就改成停止匹配 -->
            <div id="match-button">开始匹配</div>
        </div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script>
        // 页面加载的时候，发送的请求。
        $.ajax({
            type: 'get',
            url: '/userInfo',
            success: function(body) {
                // 获取screen这个标签
                let screenDiv = document.querySelector('#screen');
                screenDiv.innerHTML = '玩家：' + body.username + '   分数：' + body.score 
                    + '<br> 比赛场次：' + body.totalCount + '   获胜场数：' + body.winCount
            },
            error: function() {
                alert("获取用户信息失败！");
            }
        });

        // 此处进行初始化 websocket,并且实现前端的匹配逻辑
        // 此处的的路径必须写成 /findMatch , Not /findMatch/
        let websocket = new WebSocket('ws://127.0.0.1:8080/findMatch');
        websocket.onopen = function() {
            console.log("onOpen");
        }
        websocket.onclose = function() {
            console.log("onClose");
            // 当断开连接时（比如说多开或者是客户自己断开连接的情况下），给客户一个提示信息。
            alert("当前和服务器的连接已经断开，请重新登录！");
            location.assign("/login.html");
        }
        websocket.onerror = function() {
            console.log("onError");
        }
        
        // 监听页面关闭事件，在页面关闭之前，手动调用这里的 websocket 的close 方法。
        // 告诉server，用户退出了。
        window.onbeforeunload = function() {
            websocket.close();
        }

        // 重点实现的方法，要处理服务器返回的响应
        websocket.onmessage = function(e) {
            // 处理服务器返回的响应数据，这个响应就是针对 “开始匹配” 或者 “停止匹配” 的
            // 解析得到的响应对象，返回的数据是一个JSON字符串，解析成JS 对象
            // JSON 字符串和 JS 对象的转换：
            // JSON -> JS object: JSON.parse()
            // JS -> JSON字符串: JSON.stringify()
            let resp = JSON.parse(e.data);
            let matchButton = document.querySelector('#match-button');
            if (!resp.ok) {
                console.log("游戏大厅中，接收到了失败响应！" + resp.reason);
                return;
            }
            // 结果是true了，有如下三种情况
            if (resp.message == 'startMatch') {
                // 开始匹配，请求发送成功
                console.log("进入匹配队列");
                // 修改按钮里的文本
                matchButton.innerHTML = '匹配中...(点击停止)';
            } else if (resp.message == 'stopMatch') {
                // 结束匹配，请求发送成功
                console.log("离开匹配对列成功！");
                matchButton.innerHTML = '开始匹配';
            } else if (resp.message == 'matchSuccess') {
                // 已经匹配到对手了
                console.log("匹配到对手，进入游戏房间");
                location.assign("/game_room.html");
            } else {
                console.log("收到了非法的响应！message = " + resp.message);
            }
        }

        // 给匹配按钮添加 点击事件
        let matchButton = document.querySelector('#match-button');
        matchButton.onclick = function() {
            // 点击事件的回调
            // 触发websocket请求之前，先确认一下，websocket 连接是否好着呢
            if (websocket.readyState == websocket.OPEN) {
                // 如果当前 readyState 处在 OPEN 状态，说明连接是好的，可以发送数据
                // 这里发送的数据有两种可能，开始匹配/停止匹配。此处有两种情况，需要分开处理。
                if (matchButton.innerHTML == '开始匹配') {
                    // 发送开始匹配的请求
                    console.log("开始匹配");
                    websocket.send(JSON.stringify({                        
                            message: 'startMatch',
                    }));
                } else if (matchButton.innerHTML == '匹配中...(点击停止)') {
                    // 发送停止匹配的请求
                    console.log("停止匹配");
                    websocket.send(JSON.stringify({
                        message: 'stopMatch',                        
                    }));
                }
            } else {
                // 这是说明，连接当前是异常的状态
                alert("当前连接已经断开！请重新登录。");
                location.assign('/login.html');
            }
        } 
    </script>
</body>
</html>